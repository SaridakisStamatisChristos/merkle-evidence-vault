name: CI

on:
  push:
    branches: [ main, '**' ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure a go.sum exists for cache step
        run: |
          # If there are no go.sum files in the repository, create an empty placeholder
          # so the cache action doesn't warn about a missing dependencies file.
          shopt -s globstar || true
          found=$(ls -1 **/go.sum 2>/dev/null | wc -l || true)
          if [ "$found" -eq "0" ]; then
            echo "No go.sum found in workspace; creating placeholder go.sum"
            touch go.sum
          else
            echo "Found $found go.sum file(s); using those for cache key"
          fi

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Run gofmt
        run: |
          gofmt -l . | tee /tmp/gofmt.out || true
          if [ -s /tmp/gofmt.out ]; then
            echo "Files not gofmt'd:"; cat /tmp/gofmt.out; exit 1
          fi

      - name: Run go vet per module
        run: |
          # Find all directories containing a go.mod and run `go vet` inside them.
          set -e
          echo "Scanning repository for go.mod files..."
          find . -name go.mod -not -path "./.git/*" | while read -r mod; do
            dir=$(dirname "$mod")
            echo "Running go vet in: $dir"
            (cd "$dir" && go vet ./...)
          done

      - name: Run unit tests per module
        run: |
          # Find module roots (go.mod) and run tests inside each module
          set -e
          echo "Scanning repository for go.mod files to run tests..."
          find . -name go.mod -not -path "./.git/*" | while read -r mod; do
            dir=$(dirname "$mod")
            echo "Running go test in: $dir"
            (cd "$dir" && go test ./... -count=1 -v)
          done

  integration-e2e:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start Go JWKS stub server and generate tokens
        run: |
          # Start the Go-based JWKS stub; it prints tokens and serves /jwks.json
          nohup go run scripts/ci_jwks.go > scripts/ci_jwks_env.txt 2>&1 &

      - name: Start API server
        run: |
          echo "Starting vault-api server in background (HTTP_ADDR=:8080)"
          pushd services/vault-api/cmd/server
          nohup env HTTP_ADDR=":8080" go run . > /tmp/vault-api.log 2>&1 &
          popd
          for i in {1..60}; do
            if curl -sSf http://localhost:8080/healthz >/dev/null 2>&1; then
              echo "vault-api ready"
              break
            fi
            sleep 2
          done
          if ! curl -sSf http://localhost:8080/healthz >/dev/null 2>&1; then
            echo "vault-api failed to start"; exit 1
          fi

      - name: Dump vault-api startup log
        run: |
          echo "=== /tmp/vault-api.log ==="
          if [ -f /tmp/vault-api.log ]; then
            tail -n +1 /tmp/vault-api.log || true
          else
            echo "/tmp/vault-api.log not found"
          fi

      - name: Load CI envs and run integration helper (no test-jwt)
        shell: bash
        env:
          E2E_INGESTER_TOKEN: ingester-token-example
          E2E_AUDITOR_TOKEN: auditor-token-example
        run: |
          # wait for JWKS stub to write its environment file
          for i in {1..15}; do
            if [ -f scripts/ci_jwks_env.txt ]; then break; fi
            sleep 1
          done
          set -o allexport
          grep -v '^\
' scripts/ci_jwks_env.txt | sed 's/\r$//' | while IFS= read -r line; do export "$line"; done
          set +o allexport
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/run-integration.ps1 -EnableTestJwt:$false -ApiUrl "http://localhost:8080" -IngesterToken "$E2E_INGESTER_TOKEN" -AuditorToken "$E2E_AUDITOR_TOKEN"

      - name: CI cleanup JWKS artifacts
        run: |
          echo "Cleaning up CI JWKS artifacts"
          rm -f scripts/ci_jwks_env.txt || true
