name: CI

on:
  push:
    branches: [ main, '**' ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'

      - name: Run gofmt
        run: |
          gofmt -l . | tee /tmp/gofmt.out || true
          if [ -s /tmp/gofmt.out ]; then
            echo "Files not gofmt'd:"; cat /tmp/gofmt.out; exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run unit tests
        run: go test ./... -count=1 -v

  integration-e2e:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start Go JWKS stub server and generate tokens
        run: |
          # Start the Go-based JWKS stub; it prints tokens and serves /jwks.json
          nohup go run scripts/ci_jwks.go > scripts/ci_jwks_env.txt 2>&1 &

      - name: Load CI envs and run integration helper (no test-jwt)
        shell: bash
        env:
          # default values if script didn't output
          E2E_INGESTER_TOKEN: ingester-token-example
          E2E_AUDITOR_TOKEN: auditor-token-example
        run: |
          # Wait for JWKS stub to be ready
          for i in {1..15}; do
            if curl -sSf http://localhost:8000/jwks.json >/dev/null 2>&1; then break; fi
            sleep 1
          done
          # Source the generated env file lines
          set -o allexport
          grep -v '^\s*$' scripts/ci_jwks_env.txt | sed 's/\r$//' | while IFS= read -r line; do export "$line"; done
          set +o allexport
          export JWKS_URL=http://localhost:8000/jwks.json
          # run the PowerShell helper with test-JWT disabled so CI exercises JWKS
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/run-integration.ps1 -EnableTestJwt:$false

      - name: CI cleanup JWKS artifacts
        run: |
          echo "Cleaning up CI JWKS artifacts"
          rm -f scripts/ci_jwks_env.txt || true
