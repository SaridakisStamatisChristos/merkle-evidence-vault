name: "Fuzz (ASAN)"

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    paths:
      - '.github/workflows/fuzz.yml'
      - 'services/merkle-engine/**'
  pull_request:
    paths:
      - '.github/workflows/fuzz.yml'
      - 'services/merkle-engine/**'
  schedule:
    - cron: '0 2 * * *'

jobs:
  fuzz-asan:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld

      - name: Set up Rust (nightly)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true

      - name: Install cargo-fuzz
        run: cargo +nightly install cargo-fuzz --locked || true

      - name: Verify fuzz target
        run: |
          set -euo pipefail
          cd services/merkle-engine/fuzz
          cargo +nightly fuzz list

      - name: Run bounded ASAN fuzz
        env:
          RUSTFLAGS: "-Z sanitizer=address"
          ASAN_OPTIONS: "detect_leaks=1:abort_on_error=1:symbolize=1"
          LSAN_OPTIONS: "suppressions=/dev/null"
        run: |
          set -euo pipefail
          cd services/merkle-engine/fuzz

          heartbeat() {
            while true; do
              sleep 60
              echo "[heartbeat] fuzz-asan running at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            done
          }

          monitor_logs() {
            while true; do
              if compgen -G "fuzz-*.log" >/dev/null; then
                echo "[monitor] tail fuzz worker logs"
                tail -n 40 fuzz-*.log || true
              else
                echo "[monitor] waiting for fuzz-*.log"
              fi
              sleep 30
            done
          }

          heartbeat & HEARTBEAT_PID=$!
          monitor_logs & MONITOR_PID=$!
          trap 'kill "$HEARTBEAT_PID" "$MONITOR_PID" 2>/dev/null || true' EXIT

          timeout 8m bash -c 'cargo +nightly fuzz run tree_append_leaf -- -max_total_time=420 -rss_limit_mb=512 -jobs=1 -workers=1 -print_final_stats=1 2>&1 | tee /tmp/fuzz.log' || true

          for f in fuzz-*.log; do
            [ -f "$f" ] || continue
            echo "--- $f ---" | tee -a /tmp/fuzz.log
            tail -n 200 "$f" | tee -a /tmp/fuzz.log || true
          done

      - name: Validate fuzz output
        if: always()
        run: |
          set -euo pipefail
          if grep -E "ERROR: AddressSanitizer|ERROR: LeakSanitizer|SUMMARY: AddressSanitizer" /tmp/fuzz.log; then
            echo "ASAN/LSAN error detected"
            exit 1
          fi
          if grep -Eq "#.*(pulse|NEW|REDUCE)|stat::number_of_executed_units" /tmp/fuzz.log; then
            echo "Fuzzer produced progress output"
          else
            echo "Fuzzer did not produce progress output"
            tail -n 200 /tmp/fuzz.log || true
            exit 1
          fi

      - name: Upload fuzz artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-asan-artifacts
          path: |
            /tmp/fuzz.log
            services/merkle-engine/fuzz/fuzz-*.log
            services/merkle-engine/fuzz/artifacts/tree_append_leaf/**
            services/merkle-engine/fuzz/corpus/tree_append_leaf/**

  fuzz-scheduled:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld

      - name: Set up Rust (nightly)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true

      - name: Install cargo-fuzz
        run: cargo +nightly install cargo-fuzz --locked || true

      - name: Scheduled fuzz run (ASAN)
        env:
          RUSTFLAGS: "-Z sanitizer=address"
          ASAN_OPTIONS: "detect_leaks=1:abort_on_error=1:symbolize=1"
        run: |
          set -euo pipefail
          cd services/merkle-engine/fuzz

          heartbeat() {
            while true; do
              sleep 60
              echo "[heartbeat] fuzz-scheduled running at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            done
          }

          monitor_logs() {
            while true; do
              if compgen -G "fuzz-*.log" >/dev/null; then
                echo "[monitor] tail fuzz worker logs"
                tail -n 80 fuzz-*.log || true
              else
                echo "[monitor] waiting for fuzz-*.log"
              fi
              sleep 30
            done
          }

          heartbeat & HEARTBEAT_PID=$!
          monitor_logs & MONITOR_PID=$!
          trap 'kill "$HEARTBEAT_PID" "$MONITOR_PID" 2>/dev/null || true' EXIT

          timeout 20m bash -c 'cargo +nightly fuzz run tree_append_leaf -- -max_total_time=1080 -rss_limit_mb=512 -jobs=1 -workers=1 -print_final_stats=1 2>&1 | tee /tmp/fuzz.log' || true

          for f in fuzz-*.log; do
            [ -f "$f" ] || continue
            echo "--- $f ---" | tee -a /tmp/fuzz.log
            tail -n 400 "$f" | tee -a /tmp/fuzz.log || true
          done

      - name: Validate scheduled output
        if: always()
        run: |
          set -euo pipefail
          if grep -E "ERROR: AddressSanitizer|ERROR: LeakSanitizer|SUMMARY: AddressSanitizer" /tmp/fuzz.log; then
            echo "ASAN/LSAN error detected"
            exit 1
          fi
          if grep -Eq "#.*(pulse|NEW|REDUCE)|stat::number_of_executed_units" /tmp/fuzz.log; then
            echo "Scheduled fuzzer produced progress output"
          else
            echo "Scheduled fuzzer did not produce progress output"
            tail -n 200 /tmp/fuzz.log || true
            exit 1
          fi

      - name: Upload scheduled artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-scheduled-artifacts
          path: |
            /tmp/fuzz.log
            services/merkle-engine/fuzz/fuzz-*.log
            services/merkle-engine/fuzz/artifacts/tree_append_leaf/**
            services/merkle-engine/fuzz/corpus/tree_append_leaf/**
